
## 使用GeoHash算法计算范围内所有点
#### 场景：用户数量百万+，每个用户均有唯一一个最近定位
#### 需求：查询指定用户附近 x km ~ y km 的所有用户 user_no、距离
#### 方案：使用地图网格GeoHash算法将用户载入网格，查询时根据网格查询网格内所有用户，再循环网格内所有用户对比距离值

## 一、略知 GeoHash

1. GeoHash 是一种将 **经纬度坐标转换为字符串** 的编码方式，它可以将二维的经纬度数据编码为字符串，同时也可以将字符串解码为经纬度数据。GeoHash 的编码方式是将二维的经纬度数据编码为一维的字符串，编码后的字符串长度越长，表示的范围越精确，反之则越不精确。

2. 具体操作为：将 -180 ~ 180 经度均分为 180 份，将 -90 ~ 90 纬度均分为 90 份，然后将经纬度转换为二进制
3. 然后将经纬度的二进制再按照经度、纬度的顺序拼接起来，最后将拼接后的二进制转换为十进制，再将十进制转换为 32 进制（base32编码），最后得到的字符串就是 GeoHash 编码后的字符串。

### **Geo字符串长度与误差的关系对比表格**
| Geohash 字符串长度 (Base32) | 纬度二进制位数 (Lat bits) | 经度二进制位数 (Lng bits) | 纬度方向误差 (°) | 经度方向误差  (°) | 矩形边长误差 (km) |
| -------- | -------- | -------- | -------- | -------- | -------- |
| 1 | 2 | 3 | ±23 | ±23 | ±2500 |
| 2 | 5 | 5 | ±2.8 | ±5.6 | ±630 |
| 3 | 7 | 8 | ±0.70 | ±0.70 | ±78 |
| 4 | 10 | 10 | ±0.087 | ±0.18 | ±20 |
| 5 | 12 | 13 | ±0.022 | ±0.022 | ±2.4 |
| 6 | 15 | 15 | ±0.0027 | ±0.0055 | ±0.61 |
| 7 | 17 | 18 | ±0.00068 | ±0.00068 | ±0.076 |
| 8 | 20 | 20 | ±0.000085 | ±0.00017 | ±0.019 |

## 二、根据距离查找范围内点思路

1. 将所有用户的经纬度转换为 GeoHash 字符串，然后将 GeoHash 字符串按照前缀进行分组，每个前缀代表一个网格。
2. 当需要查询某个用户附近的用户时：
    - 将该用户的经纬度转换为 GeoHash 字符串
    - 然后根据所需查找的距离长短，计算出该距离对应的 GeoHash 字符串长度
    - 然后根据 GeoHash 字符串的前缀找到该用户所在的网格、以及该网格周围的网格
    - 然后再循环该指定网格内的所有用户，计算距离，最后返回距离在指定范围内的用户
3. 效率优化思路
    - 当需要查询的最大距离为 xkm 时，假设x为200；
    - 根据对应表格，字符串长度为3时，误差为78km，字符串长度为2时，误差为630km；
    - 由此我们可以采用字符串长度为3的网格进行查询，并且向外扩展至三层网格，即查询范围为 78 * 3 = 234km，这样就可以覆盖 200km 的查询范围，同时也可以减少符合条件的网格用户列表的循环次数，提高查询效率。
    - 排除不满最少距离要求的用户，通过如果当前网格的最大距离小于最小距离，则排除该网格内所有用户，不再进行距离计算。

